<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>城际出行购票 - 微信公众号版</title>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Helvetica Neue", sans-serif; }
        body { background-color: #f5f5f5; padding: 15px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #34495e; font-size: 14px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #219653; }
        #priceResult { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; font-size: 15px; color: #e74c3c; font-weight: bold; }
        #payCode { margin: 20px 0; text-align: center; display: none; }
        #payCode img { width: 250px; height: 250px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .nav-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .nav-btn { flex: 1; padding: 10px; background: #3498db; font-size: 14px; }
        .admin-panel { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd; display: none; }
        .order-count { text-align: center; margin: 10px 0; color: #7f8c8d; font-size: 14px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>城际出行在线购票</h2>
        
        <!-- 乘客购票区 -->
        <div class="form-group">
            <label>选择出发地</label>
            <select id="startPoint">
                <option value="A">A点 - 忻城县人民医院</option>
                <option value="A1">A1点 - 古蓬镇</option>
            </select>
        </div>
        <div class="form-group">
            <label>选择目的地类型</label>
            <select id="destType">
                <option value="B">B点 - 柳州柳堡加油站</option>
                <option value="B1">B1点（超B点短途）</option>
                <option value="B2">B2点（超B点长途）</option>
            </select>
        </div>
        <div class="form-group" id="extraKmGroup" class="hidden">
            <label>超B/B1点额外公里数</label>
            <input type="number" id="extraKm" placeholder="请输入额外公里数" min="0">
        </div>

        <button onclick="calculatePrice()">计算票价</button>
        <div id="priceResult">请计算票价后购票</div>
        <button onclick="showPayCode()">确认购票（展示收款码）</button>

        <!-- 收款码展示区 -->
        <div id="payCode">
            <p>请扫码支付，支付后联系司机确认</p >
            < img id="codeImg" src="" alt="司机收款码">
        </div>

        <!-- 司机导航区 -->
        <div class="admin-panel" id="driverNav">
            <h3 style="font-size:16px; margin:15px 0;">司机导航</h3>
            <div class="nav-btn-group">
                <button class="nav-btn" onclick="openGaodeMap()">高德地图</button>
                <button class="nav-btn" onclick="openTencentMap()">腾讯地图</button>
                <button class="nav-btn" onclick="openBaiduMap()">百度地图</button>
            </div>
            <div class="order-count">当前订单数：<span id="orderCount">0</span> / 100</div>
            <div class="order-count" id="modifyTip"></div>
        </div>

        <!-- 管理员登录区 -->
        <div class="admin-panel" id="adminLogin">
            <h3 style="font-size:16px; margin:15px 0;">管理员登录</h3>
            <div class="form-group">
                <label>账号</label>
                <input type="text" id="adminUser" placeholder="管理员账号">
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" id="adminPwd" placeholder="管理员密码">
            </div>
            <button onclick="adminLogin()">登录</button>
        </div>

        <!-- 管理员操作区 -->
        <div class="admin-panel" id="adminPanel">
            <h3 style="font-size:16px; margin:15px 0;">司机资料管理</h3>
            <div class="form-group">
                <label>上传司机收款码（图片）</label>
                <input type="file" id="codeFile" accept="image/*">
            </div>
            <div class="form-group">
                <label>更新订单数</label>
                <input type="number" id="updateOrderCount" placeholder="输入当前订单数" min="0">
            </div>
            <button onclick="uploadDriverInfo()">保存司机信息</button>
            <button onclick="resetAdmin()">退出登录</button>
        </div>
    </div>

    <script>
        // 固定点位坐标 [lng, lat] - Turf.js 格式
        const POINTS = {
            A: turf.point([108.6812, 24.0856]),
            A1: turf.point([108.5234, 24.1567]),
            B: turf.point([109.3678, 24.2134])
        };
        // 基础价格配置
        const PRICE_RULES = {
            A_TO_B: 50,
            A1_TO_B: 60,
            A_TO_B1: 60,
            EXTRA_0_20: 0.8,
            EXTRA_20_PLUS: 0.7,
            A1_B_OVER_120: 0.61,
            LIMIT_120: 120,
            LIMIT_20: 20
        };
        // 全局状态
        let adminStatus = false;
        let driverCode = localStorage.getItem('driverCode') || '';
        let orderCount = parseInt(localStorage.getItem('orderCount')) || 0;
        let lastModifyTime = localStorage.getItem('lastModifyTime') || 0;

        // 初始化
        window.onload = function() {
            document.getElementById('orderCount').innerText = orderCount;
            checkModifyPermission();
            // 显示管理员登录入口
            document.getElementById('adminLogin').style.display = 'block';
            // 监听目的地类型变化
            document.getElementById('destType').addEventListener('change', function(e) {
                if (e.target.value !== 'B') {
                    document.getElementById('extraKmGroup').style.display = 'block';
                } else {
                    document.getElementById('extraKmGroup').style.display = 'none';
                }
            });
        };

        // 1. 票价计算核心逻辑
        function calculatePrice() {
            const start = document.getElementById('startPoint').value;
            const destType = document.getElementById('destType').value;
            const extraKm = parseFloat(document.getElementById('extraKm').value) || 0;
            let totalPrice = 0;
            let distanceAB = turf.distance(POINTS[start], POINTS.B, {units: 'kilometers'});

            // 规则1: A/A1到B点基础价
            if (destType === 'B') {
                totalPrice = start === 'A' ? PRICE_RULES.A_TO_B : PRICE_RULES.A1_TO_B;
                // 规则3: A1→B超120公里重新计费
                if (start === 'A1' && distanceAB > PRICE_RULES.LIMIT_120) {
                    totalPrice = distanceAB * PRICE_RULES.A1_B_OVER_120;
                }
            } else {
                // 规则2: 到B1/B2点（超B点）
                totalPrice = start === 'A' ? PRICE_RULES.A_TO_B1 : PRICE_RULES.A1_TO_B;
                let extraPrice = 0;
                if (extraKm <= PRICE_RULES.LIMIT_20) {
                    extraPrice = extraKm * PRICE_RULES.EXTRA_0_20;
                } else {
                    extraPrice = PRICE_RULES.LIMIT_20 * PRICE_RULES.EXTRA_0_20 + (extraKm - PRICE_RULES.LIMIT_20) * PRICE_RULES.EXTRA_20_PLUS;
                }
                totalPrice += extraPrice;
            }

            document.getElementById('priceResult').innerText = `最终票价：${totalPrice.toFixed(2)} 元`;
        }

        // 2. 展示收款码
        function showPayCode() {
            const payCode = document.getElementById('payCode');
            if (!driverCode) {
                alert('司机收款码未上传，请联系管理员！');
                return;
            }
            document.getElementById('codeImg').src = driverCode;
            payCode.style.display = 'block';
            // 模拟订单计数+1
            if (adminStatus) {
                updateOrderCount(1);
            }
        }

        // 3. 司机导航跳转
        function openGaodeMap() {
            const start = document.getElementById('startPoint').value;
            const startName = start === 'A' ? '忻城县人民医院' : '古蓬镇';
            window.open(`https://amap.com/navigation?from=${POINTS[start].geometry.coordinates[1]},${POINTS[start].geometry.coordinates[0]}&to=${POINTS.B.geometry.coordinates[1]},${POINTS.B.geometry.coordinates[0]}&name=${startName}到柳州柳堡加油站`, '_blank');
        }
        function openTencentMap() {
            const start = document.getElementById('startPoint').value;
            window.open(`https://map.qq.com/navigation.html?type=drive&from=${POINTS[start].geometry.coordinates[1]},${POINTS[start].geometry.coordinates[0]}&to=${POINTS.B.geometry.coordinates[1]},${POINTS.B.geometry.coordinates[0]}`, '_blank');
        }
        function openBaiduMap() {
            const start = document.getElementById('startPoint').value;
            window.open(`https://map.baidu.com/direction?origin=${POINTS[start].geometry.coordinates[1]},${POINTS[start].geometry.coordinates[0]}&destination=${POINTS.B.geometry.coordinates[1]},${POINTS.B.geometry.coordinates[0]}&mode=driving`, '_blank');
        }

        // 4. 管理员登录
        function adminLogin() {
            const user = document.getElementById('adminUser').value;
            const pwd = document.getElementById('adminPwd').value;
            if (user === 'adim' && pwd === '88888888') {
                adminStatus = true;
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('driverNav').style.display = 'block';
                document.getElementById('adminLogin').style.display = 'none';
                alert('管理员登录成功！');
            } else {
                alert('账号或密码错误！');
            }
        }

        // 5. 上传司机资料&收款码
        function uploadDriverInfo() {
            const file = document.getElementById('codeFile').files[0];
            if (!file) {
                alert('请选择收款码图片！');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                driverCode = e.target.result;
                localStorage.setItem('driverCode', driverCode);
                alert('收款码上传成功！');
            };
            reader.readAsDataURL(file);
            // 更新订单数
            const newCount = parseInt(document.getElementById('updateOrderCount').value) || 0;
            localStorage.setItem('orderCount', newCount);
            orderCount = newCount;
            document.getElementById('orderCount').innerText = orderCount;
            checkModifyPermission();
        }

        // 6. 订单数更新&修改权限检查
        function updateOrderCount(num) {
            orderCount += num;
            orderCount = Math.min(orderCount, 100);
            localStorage.setItem('orderCount', orderCount);
            document.getElementById('orderCount').innerText = orderCount;
            checkModifyPermission();
        }
        function checkModifyPermission() {
            const tip = document.getElementById('modifyTip');
            if (orderCount < 100) {
                tip.innerText = '订单未满100单，暂不可修改资料';
                tip.style.color = '#7f8c8d';
                return;
            }
            const now = Date.now();
            const canModify = now - lastModifyTime >= 15 * 24 * 60 * 60 * 1000;
            if (canModify) {
                tip.innerText = '已接满100单，可修改资料（每15天一次）';
                tip.style.color = '#27ae60';
            } else {
                const leftTime = Math.ceil((15 * 24 * 60 * 60 * 1000 - (now - lastModifyTime)) / (24 * 60 * 60 * 1000));
                tip.innerText = `距离下次可修改还有 ${leftTime} 天`;
                tip.style.color = '#e74c3c';
            }
        }

        // 7. 管理员退出
        function resetAdmin() {
            adminStatus = false;
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('driverNav').style.display = 'none';
            document.getElementById('adminLogin').style.display = 'block';
        }
    </script>
</body>

</html>
