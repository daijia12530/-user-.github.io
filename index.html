<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="å¿»åŸ-æŸ³å·åŸé™…å‡ºè¡Œç³»ç»Ÿ - å¾®ä¿¡ç«¯ä¸“ç”¨">
    <meta name="author" content="åŸé™…å‡ºè¡Œç³»ç»Ÿ">
    <title>åŸé™…å‡ºè¡Œç³»ç»Ÿ | å¿»åŸ-æŸ³å·ä¸“çº¿</title>
    
    <!-- PWAé…ç½® -->
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;åŸé™…å‡ºè¡Œç³»ç»Ÿ&quot;,&quot;short_name&quot;:&quot;åŸé™…å‡ºè¡Œ&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#667eea&quot;,&quot;theme_color&quot;:&quot;#667eea&quot;}">
    
    <style>
        /* ===== åŸºç¡€æ ·å¼é‡ç½® ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 14px;
            height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== é€šç”¨ç»„ä»¶ ===== */
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: bold;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #999;
            text-decoration: none;
            padding: 5px;
            flex: 1;
        }
        
        .tab-item.active {
            color: #667eea;
        }
        
        .tab-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        /* ===== ç™»å½•é¡µé¢æ ·å¼ ===== */
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .login-logo p {
            opacity: 0.9;
        }
        
        .login-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .login-tabs {
            display: flex;
            background: #f8f9fa;
        }
        
        .login-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
        }
        
        .login-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .login-form {
            padding: 30px;
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        /* ===== ä¹˜å®¢ç«¯æ ·å¼ ===== */
        .passenger-content {
            padding-bottom: 70px;
        }
        
        .route-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .route-btn {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .route-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .price-display {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }
        
        .price-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .price-value {
            font-size: 36px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .price-details {
            margin: 15px 0;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .price-row.total {
            border-bottom: none;
            border-top: 2px solid #667eea;
            font-weight: bold;
            padding-top: 12px;
            margin-top: 8px;
        }
        
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .order-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #667eea;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .order-id {
            font-size: 12px;
            color: #666;
        }
        
        .order-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #d4edda;
            color: #155724;
        }
        
        .order-route {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .order-time {
            font-size: 12px;
            color: #666;
        }
        
        /* ===== å¸æœºç«¯æ ·å¼ ===== */
        .driver-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .route-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .route-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .route-info h4 {
            margin-bottom: 5px;
        }
        
        .route-path {
            font-size: 12px;
            color: #666;
        }
        
        .route-actions {
            display: flex;
            gap: 5px;
        }
        
        .price-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ===== èŠå¤©é¡µé¢æ ·å¼ ===== */
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-back {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .chat-title {
            flex: 1;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        
        .message.received {
            align-self: flex-start;
            background: white;
            border-bottom-left-radius: 4px;
        }
        
        .message.sent {
            align-self: flex-end;
            background: #95ec69;
            border-bottom-right-radius: 4px;
        }
        
        .message-system {
            align-self: center;
            background: rgba(0,0,0,0.1);
            color: #666;
            font-size: 12px;
            padding: 5px 15px;
            border-radius: 10px;
        }
        
        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        
        .chat-input-area {
            background: white;
            padding: 10px 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            border: 2px solid #eee;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            resize: none;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* ===== æ”¯ä»˜é¡µé¢æ ·å¼ ===== */
        .payment-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .payment-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .payment-amount {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }
        
        .amount-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .amount {
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .payment-methods {
            margin: 20px 0;
        }
        
        .method-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .method-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .method-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            color: white;
        }
        
        .method-icon.wechat {
            background: #07c160;
        }
        
        .method-icon.alipay {
            background: #108ee9;
        }
        
        .method-icon.cash {
            background: #f0ad4e;
        }
        
        .method-info {
            flex: 1;
        }
        
        .method-name {
            font-weight: bold;
        }
        
        .method-desc {
            font-size: 12px;
            color: #666;
        }
        
        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-tips {
            font-size: 14px;
            color: #666;
        }
        
        /* ===== å“åº”å¼è°ƒæ•´ ===== */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .tab-bar {
                max-width: 768px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
        }
        
        /* ===== çŠ¶æ€æŒ‡ç¤ºå™¨ ===== */
        .status-online {
            color: #28a745;
        }
        
        .status-offline {
            color: #dc3545;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¡µé¢ -->
        <div class="page active" id="loginPage">
            <div class="login-page">
                <div class="login-logo">
                    <h1>åŸé™…å‡ºè¡Œç³»ç»Ÿ</h1>
                    <p>å¿»åŸ-æŸ³å·ä¸“çº¿ | å¾®ä¿¡ç«¯ä¸“ç”¨</p>
                </div>
                
                <div class="login-card">
                    <div class="login-tabs">
                        <button class="login-tab active" onclick="switchLoginTab('passenger')">ä¹˜å®¢ç«¯</button>
                        <button class="login-tab" onclick="switchLoginTab('driver')">å¸æœºç«¯</button>
                    </div>
                    
                    <!-- ä¹˜å®¢ç™»å½•è¡¨å• -->
                    <div class="login-form active" id="passengerLoginForm">
                        <form id="passengerLogin" onsubmit="loginAsPassenger(event)">
                            <div class="form-group">
                                <label class="form-label">æ‰‹æœºå·ç </label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="tel" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" required pattern="1[0-9]{10}">
                                    <button type="button" class="btn btn-secondary" onclick="sendSMSCode()" style="min-width: 100px;">è·å–éªŒè¯ç </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">éªŒè¯ç </label>
                                <input type="text" class="form-control" placeholder="è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç " required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">å¸¸ç”¨åœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-control" placeholder="å¦‚ï¼šå¿»åŸå¿äººæ°‘åŒ»é™¢">
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">è¿›å…¥ä¹˜å®¢ç«¯</button>
                        </form>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-secondary btn-block" onclick="quickLogin('passenger')">å¿«é€Ÿä½“éªŒï¼ˆå…ç™»å½•ï¼‰</button>
                        </div>
                    </div>
                    
                    <!-- å¸æœºç™»å½•è¡¨å• -->
                    <div class="login-form" id="driverLoginForm">
                        <form id="driverLogin" onsubmit="loginAsDriver(event)">
                            <div class="form-group">
                                <label class="form-label">å¸æœºç¼–å·</label>
                                <input type="text" class="form-control" placeholder="è¯·è¾“å…¥å¸æœºç¼–å·" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">è½¦ç‰Œå·ç </label>
                                <input type="text" class="form-control" placeholder="å¦‚ï¼šæ¡‚B12345" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">å¯†ç </label>
                                <input type="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">è¿›å…¥å¸æœºç«¯</button>
                        </form>
                        
                        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
                            <p>æ–°å¸æœºè¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œ</p>
                            <p>ç”µè¯ï¼š0772-XXXXXXX</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: center; color: rgba(255,255,255,0.9);">
                    <p>å»ºè®®æ”¶è—åˆ°å¾®ä¿¡ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨</p>
                    <p style="font-size: 12px;">ç‚¹å‡»å³ä¸Šè§’ Â·Â·Â· â†’ æ”¶è—</p>
                </div>
            </div>
        </div>
        
        <!-- ä¹˜å®¢ç«¯é¡µé¢ -->
        <div class="page" id="passengerPage">
            <div class="header">
                <h1>ä¹˜å®¢ç«¯ - åŸé™…å‡ºè¡Œ</h1>
            </div>
            
            <div class="passenger-content">
                <!-- å½“å‰ä½ç½® -->
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 20px;">ğŸ“</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #666;">å½“å‰ä½ç½®</div>
                            <div id="currentLocation">å®šä½ä¸­...</div>
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="refreshLocation()">åˆ·æ–°</button>
                    </div>
                </div>
                
                <!-- è·¯çº¿é€‰æ‹© -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">é€‰æ‹©è·¯çº¿</h3>
                    <div class="route-selector">
                        <button class="route-btn active" onclick="selectRoute('xincheng-liuzhou')">å¿»åŸâ†’æŸ³å·</button>
                        <button class="route-btn" onclick="selectRoute('liuzhou-xincheng')">æŸ³å·â†’å¿»åŸ</button>
                        <button class="route-btn" onclick="selectRoute('xincheng-laibin')">å¿»åŸâ†’æ¥å®¾åŒ—</button>
                        <button class="route-btn" onclick="selectRoute('gupeng-xincheng')">å¤è“¬â†’å¿»åŸ</button>
                        <button class="route-btn" onclick="selectRoute('custom')">è‡ªå®šä¹‰</button>
                    </div>
                </div>
                
                <!-- ç›®çš„åœ°è¾“å…¥ -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">ç›®çš„åœ°è®¾ç½®</h3>
                    <div class="form-group">
                        <label class="form-label">ç›®çš„åœ°åœ°å€</label>
                        <input type="text" class="form-control" id="destinationInput" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼Œå¦‚ï¼šæŸ³å·ç«è½¦ç«™" oninput="updateDestination()">
                    </div>
                    
                    <div class="form-group" id="extraDistanceGroup" style="display: none;">
                        <label class="form-label">é¢å¤–è·ç¦» <span id="distanceValue">0</span>å…¬é‡Œ</label>
                        <input type="range" class="form-control" id="extraDistance" min="0" max="100" value="0" oninput="updateDistanceValue(this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å…·ä½“ä½ç½®è¯´æ˜</label>
                        <textarea class="form-textarea" id="locationNote" placeholder="å¦‚ï¼šåœ¨å‡ºç«™å£ç­‰å€™ã€å°åŒºé—¨å£ç­‰"></textarea>
                    </div>
                </div>
                
                <!-- ä»·æ ¼è®¡ç®— -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">ä»·æ ¼è®¡ç®—</h3>
                    <div class="price-display">
                        <div class="price-label">é¢„ä¼°ä»·æ ¼</div>
                        <div class="price-value" id="totalPrice">Â¥50.00</div>
                    </div>
                    
                    <div class="price-details">
                        <div class="price-row">
                            <span>åŸºç¡€ç¥¨ä»·</span>
                            <span id="basePrice">Â¥50.00</span>
                        </div>
                        <div class="price-row">
                            <span>é¢å¤–è·ç¦»è´¹ç”¨</span>
                            <span id="extraPrice">Â¥0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>æ€»è®¡</span>
                            <span id="finalPrice">Â¥50.00</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" style="margin-right: 10px;" onclick="resetBooking()">é‡ç½®</button>
                        <button class="btn btn-primary" onclick="showDrivers()">æŸ¥çœ‹å¯ç”¨å¸æœº</button>
                    </div>
                </div>
                
                <!-- å¸æœºåˆ—è¡¨ -->
                <div class="card" id="driversCard" style="display: none;">
                    <h3 style="margin-bottom: 15px;">å¯ç”¨å¸æœº</h3>
                    <div id="driversList">
                        <!-- åŠ¨æ€åŠ è½½å¸æœºåˆ—è¡¨ -->
                    </div>
                </div>
                
                <!-- æˆ‘çš„è®¢å• -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">æˆ‘çš„è®¢å•</h3>
                    <div class="order-list" id="passengerOrders">
                        <!-- åŠ¨æ€åŠ è½½è®¢å• -->
                    </div>
                </div>
            </div>
            
            <!-- ä¹˜å®¢ç«¯åº•éƒ¨å¯¼èˆª -->
            <div class="tab-bar">
                <a class="tab-item active" onclick="switchPassengerTab('home')">
                    <span class="tab-icon">ğŸ </span>
                    <span>é¦–é¡µ</span>
                </a>
                <a class="tab-item" onclick="switchPassengerTab('orders')">
                    <span class="tab-icon">ğŸ“‹</span>
                    <span>è®¢å•</span>
                </a>
                <a class="tab-item" onclick="openChat('passenger')">
                    <span class="tab-icon">ğŸ’¬</span>
                    <span>æ¶ˆæ¯</span>
                    <span id="unreadCount" style="position: absolute; top: 0; right: 10px; background: red; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none;">0</span>
                </a>
                <a class="tab-item" onclick="switchPassengerTab('profile')">
                    <span class="tab-icon">ğŸ‘¤</span>
                    <span>æˆ‘çš„</span>
                </a>
            </div>
        </div>
        
        <!-- å¸æœºç«¯é¡µé¢ -->
        <div class="page" id="driverPage">
            <div class="header">
                <h1>å¸æœºå·¥ä½œå°</h1>
            </div>
            
            <div style="padding: 15px; padding-bottom: 70px;">
                <!-- ä»Šæ—¥ç»Ÿè®¡ -->
                <div class="driver-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="todayOrders">0</div>
                        <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayIncome">Â¥0</div>
                        <div class="stat-label">ä»Šæ—¥æ”¶å…¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="driverRating">5.0</div>
                        <div class="stat-label">æœåŠ¡è¯„åˆ†</div>
                    </div>
                    <div class="stat-card" onclick="showWithdraw()">
                        <div class="stat-value" id="driverBalance">Â¥0</div>
                        <div class="stat-label">å¯æç°</div>
                    </div>
                </div>
                
                <!-- å¸æœºçŠ¶æ€ -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin-bottom: 5px;">æ¥å•çŠ¶æ€</h3>
                            <div id="driverStatusText" class="status-online">â— åœ¨çº¿æ¥å•ä¸­</div>
                        </div>
                        <button class="btn" id="toggleStatusBtn" onclick="toggleDriverStatus()">åœæ­¢æ¥å•</button>
                    </div>
                </div>
                
                <!-- æˆ‘çš„è·¯çº¿ -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">æˆ‘çš„è·¯çº¿</h3>
                        <button class="btn btn-small btn-primary" onclick="showAddRouteModal()">+ æ·»åŠ è·¯çº¿</button>
                    </div>
                    
                    <div class="route-list" id="driverRoutes">
                        <!-- åŠ¨æ€åŠ è½½è·¯çº¿ -->
                    </div>
                </div>
                
                <!-- ä»·æ ¼è®¾ç½® -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">ä»·æ ¼è®¾ç½®</h3>
                    <div class="price-settings">
                        <div class="setting-row">
                            <span>åŸºç¡€ä»·æ ¼ï¼ˆå…ƒï¼‰</span>
                            <input type="number" class="form-control" style="width: 80px;" id="driverBasePrice" value="50" min="30" max="200" onchange="saveDriverSettings()">
                        </div>
                        <div class="setting-row">
                            <span>é¢å¤–é‡Œç¨‹è´¹ï¼ˆå…ƒ/å…¬é‡Œï¼‰</span>
                            <input type="number" step="0.1" class="form-control" style="width: 80px;" id="driverExtraRate" value="0.8" min="0.5" max="2" onchange="saveDriverSettings()">
                        </div>
                        <div class="setting-row">
                            <span>èŠ‚å‡æ—¥åŠ ä»·æ¯”ä¾‹</span>
                            <input type="number" class="form-control" style="width: 80px;" id="driverHolidayRate" value="20" min="0" max="50" onchange="saveDriverSettings()">%
                        </div>
                    </div>
                </div>
                
                <!-- å½“å‰è®¢å• -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">å½“å‰è®¢å•</h3>
                    <div class="order-list" id="driverCurrentOrders">
                        <!-- åŠ¨æ€åŠ è½½è®¢å• -->
                    </div>
                </div>
            </div>
            
            <!-- å¸æœºç«¯åº•éƒ¨å¯¼èˆª -->
            <div class="tab-bar">
                <a class="tab-item active" onclick="switchDriverTab('home')">
                    <span class="tab-icon">ğŸ </span>
                    <span>å·¥ä½œå°</span>
                </a>
                <a class="tab-item" onclick="switchDriverTab('orders')">
                    <span class="tab-icon">ğŸ“¦</span>
                    <span>è®¢å•ç®¡ç†</span>
                </a>
                <a class="tab-item" onclick="openChat('driver')">
                    <span class="tab-icon">ğŸ’¬</span>
                    <span>æ¶ˆæ¯</span>
                    <span id="driverUnreadCount" style="position: absolute; top: 0; right: 10px; background: red; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: none;">0</span>
                </a>
                <a class="tab-item" onclick="switchDriverTab('profile')">
                    <span class="tab-icon">ğŸ‘¤</span>
                    <span>æˆ‘çš„</span>
                </a>
            </div>
        </div>
        
        <!-- èŠå¤©é¡µé¢ -->
        <div class="page" id="chatPage">
            <div class="chat-container">
                <div class="chat-header">
                    <button class="chat-back" onclick="goBackFromChat()">â€¹</button>
                    <div class="chat-title" id="chatWith">å¸æœº æå¸ˆå‚…</div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- æ¶ˆæ¯åŠ¨æ€åŠ è½½ -->
                    <div class="message system">ç³»ç»Ÿï¼šå¼€å§‹èŠå¤©å§ï¼</div>
                </div>
                
                <div class="chat-input-area">
                    <textarea class="chat-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="adjustChatInput()"></textarea>
                    <button class="send-btn" id="sendMessageBtn" onclick="sendMessage()" disabled>â€º</button>
                </div>
            </div>
        </div>
        
        <!-- æ”¯ä»˜é¡µé¢ -->
        <div class="page" id="paymentPage">
            <div class="payment-page">
                <div class="payment-card">
                    <div class="payment-amount">
                        <div class="amount-label">æ”¯ä»˜é‡‘é¢</div>
                        <div class="amount" id="paymentAmount">Â¥65.00</div>
                    </div>
                    
                    <div class="payment-methods">
                        <h3 style="margin-bottom: 15px;">é€‰æ‹©æ”¯ä»˜æ–¹å¼</h3>
                        
                        <div class="method-item active" onclick="selectPaymentMethod('wechat')">
                            <div class="method-icon wechat">ğŸ’°</div>
                            <div class="method-info">
                                <div class="method-name">å¾®ä¿¡æ”¯ä»˜</div>
                                <div class="method-desc">æ¨èå¾®ä¿¡ç”¨æˆ·ä½¿ç”¨</div>
                            </div>
                            <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; position: relative;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; background: #667eea; border-radius: 50%;"></div>
                            </div>
                        </div>
                        
                        <div class="method-item" onclick="selectPaymentMethod('alipay')">
                            <div class="method-icon alipay">ğŸ’°</div>
                            <div class="method-info">
                                <div class="method-name">æ”¯ä»˜å®</div>
                                <div class="method-desc">æ¨èæ”¯ä»˜å®ç”¨æˆ·ä½¿ç”¨</div>
                            </div>
                            <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%;"></div>
                        </div>
                        
                        <div class="method-item" onclick="selectPaymentMethod('cash')">
                            <div class="method-icon cash">ğŸ’µ</div>
                            <div class="method-info">
                                <div class="method-name">ç°é‡‘æ”¯ä»˜</div>
                                <div class="method-desc">ä¹˜è½¦æ—¶æ”¯ä»˜ç»™å¸æœº</div>
                            </div>
                            <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%;"></div>
                        </div>
                    </div>
                    
                    <!-- å¾®ä¿¡æ”¯ä»˜äºŒç»´ç  -->
                    <div class="qr-code-container" id="wechatQR">
                        <div class="qr-tips">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</div>
                        <div class="qr-code">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">ç¤ºä¾‹äºŒç»´ç </div>
                                <div style="width: 160px; height: 160px; background: #f0f0f0; border-radius: 4px; margin: 0 auto;"></div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="uploadQRCode('wechat')">ä¸Šä¼ æ”¶æ¬¾ç </button>
                        </div>
                    </div>
                    
                    <!-- æ”¯ä»˜å®äºŒç»´ç  -->
                    <div class="qr-code-container" id="alipayQR" style="display: none;">
                        <div class="qr-tips">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</div>
                        <div class="qr-code">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">ç¤ºä¾‹äºŒç»´ç </div>
                                <div style="width: 160px; height: 160px; background: #f0f0f0; border-radius: 4px; margin: 0 auto;"></div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="uploadQRCode('alipay')">ä¸Šä¼ æ”¶æ¬¾ç </button>
                        </div>
                    </div>
                    
                    <!-- ç°é‡‘æ”¯ä»˜è¯´æ˜ -->
                    <div id="cashInstructions" style="display: none; padding: 15px; background: #fff8e1; border-radius: 8px; margin: 20px 0;">
                        <h4 style="margin-bottom: 10px; color: #f0ad4e;">ç°é‡‘æ”¯ä»˜è¯´æ˜</h4>
                        <ul style="font-size: 13px; color: #666; line-height: 1.6;">
                            <li>1. è¯·åœ¨ä¸Šè½¦æ—¶å‘å¸æœºæ”¯ä»˜è½¦è´¹</li>
                            <li>2. å»ºè®®å‡†å¤‡é›¶é’±ï¼Œæ–¹ä¾¿æ‰¾é›¶</li>
                            <li>3. æ”¯ä»˜åè¯·å‘å¸æœºç´¢è¦æ”¶æ®</li>
                            <li>4. å¦‚é‡é—®é¢˜ï¼Œè¯·åŠæ—¶è”ç³»å®¢æœ</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary btn-block" onclick="processPayment()">ç¡®è®¤æ”¯ä»˜</button>
                        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                            æ”¯ä»˜å‰©ä½™æ—¶é—´: <span style="color: #e74c3c; font-weight: bold;" id="paymentCountdown">15:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è·¯çº¿æ¨¡æ€æ¡† -->
    <div class="modal" id="addRouteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ·»åŠ æ–°è·¯çº¿</div>
                <button class="modal-close" onclick="closeModal('addRouteModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="routeForm" onsubmit="saveRoute(event)">
                    <div class="form-group">
                        <label class="form-label">è·¯çº¿åç§°</label>
                        <input type="text" class="form-control" placeholder="å¦‚ï¼šå¿»åŸâ†’æŸ³å·å¾€è¿”çº¿" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">èµ·ç‚¹</label>
                        <select class="form-select" id="routeStart" onchange="updateRoutePoints()">
                            <option value="xincheng">å¿»åŸå¿</option>
                            <option value="gupeng">å¤è“¬é•‡</option>
                            <option value="liuzhou">æŸ³å·å¸‚åŒº</option>
                            <option value="laibin">æ¥å®¾åŒ—ç«™</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="text" class="form-control" id="customStart" placeholder="è¯·è¾“å…¥èµ·ç‚¹" style="display: none; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç»ˆç‚¹</label>
                        <select class="form-select" id="routeEnd" onchange="updateRoutePoints()">
                            <option value="liuzhou">æŸ³å·å¸‚åŒº</option>
                            <option value="xincheng">å¿»åŸå¿</option>
                            <option value="gupeng">å¤è“¬é•‡</option>
                            <option value="laibin">æ¥å®¾åŒ—ç«™</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="text" class="form-control" id="customEnd" placeholder="è¯·è¾“å…¥ç»ˆç‚¹" style="display: none; margin-top: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ˜¯å¦ä¸ºå¾€è¿”çº¿</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="isRoundTrip" onchange="toggleReturnSettings()">
                            <span>æ˜¯</span>
                        </div>
                    </div>
                    
                    <div class="form-group" id="returnSettings" style="display: none;">
                        <label class="form-label">è¿”ç¨‹é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" class="form-control" min="1" max="24" value="2">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å‘è½¦æ—¶é—´</label>
                        <input type="time" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åº§ä½æ•°</label>
                        <input type="number" class="form-control" min="1" max="15" value="7" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è·¯çº¿è¯´æ˜</label>
                        <textarea class="form-textarea" placeholder="å¦‚ï¼šé€”ç»é«˜é€Ÿã€æä¾›çŸ¿æ³‰æ°´ç­‰"></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addRouteModal')">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜è·¯çº¿</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ä¸Šä¼ äºŒç»´ç æ¨¡æ€æ¡† -->
    <div class="modal" id="uploadQRModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ä¸Šä¼ æ”¶æ¬¾ç </div>
                <button class="modal-close" onclick="closeModal('uploadQRModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="uploadQRType" style="margin-bottom: 15px; font-weight: bold;"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <input type="file" id="qrFileInput" accept="image/*" style="display: none;" onchange="handleQRUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('qrFileInput').click()">é€‰æ‹©å›¾ç‰‡</button>
                </div>
                
                <div style="font-size: 12px; color: #666; text-align: center;">
                    <p>æ”¯æŒæ ¼å¼ï¼šJPGã€PNGã€GIF</p>
                    <p>å»ºè®®å¤§å°ï¼šä¸è¶…è¿‡2MB</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ”¯ä»˜æˆåŠŸæ¨¡æ€æ¡† -->
    <div class="modal" id="paymentSuccessModal">
        <div class="modal-content">
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div style="width: 60px; height: 60px; background: #28a745; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 20px;">âœ“</div>
                <h3 style="margin-bottom: 10px;">æ”¯ä»˜æˆåŠŸï¼</h3>
                <p style="color: #666; margin-bottom: 30px;">è®¢å•å·²ç¡®è®¤ï¼Œå¸æœºå°†å°½å¿«è”ç³»æ‚¨</p>
                <button class="btn btn-primary" onclick="closePaymentSuccess()">å®Œæˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== å…¨å±€å˜é‡ =====
        let currentPage = 'login';
        let currentUser = null;
        let currentRoute = 'xincheng-liuzhou';
        let paymentTimer = null;
        let paymentTimeLeft = 15 * 60; // 15åˆ†é’Ÿ
        let chatMessages = [];
        let currentChatWith = null;
        let currentPaymentMethod = 'wechat';
        
        // ===== é¡µé¢åˆ‡æ¢å‡½æ•° =====
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId + 'Page').classList.add('active');
            currentPage = pageId;
            
            // é¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–
            if (pageId === 'passenger') {
                initPassengerPage();
            } else if (pageId === 'driver') {
                initDriverPage();
            } else if (pageId === 'payment') {
                startPaymentTimer();
            }
        }
        
        function switchLoginTab(tab) {
            // åˆ‡æ¢ç™»å½•æ ‡ç­¾
            document.querySelectorAll('.login-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åˆ‡æ¢è¡¨å•
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(tab + 'LoginForm').classList.add('active');
        }
        
        // ===== ç™»å½•åŠŸèƒ½ =====
        function sendSMSCode() {
            const phone = document.querySelector('#passengerLoginForm input[type="tel"]').value;
            
            if (!/^1[0-9]{10}$/.test(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '60ç§’åé‡è¯•';
            
            let seconds = 60;
            const timer = setInterval(() => {
                seconds--;
                btn.innerHTML = `${seconds}ç§’åé‡è¯•`;
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = 'è·å–éªŒè¯ç ';
                }
            }, 1000);
            
            // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
            console.log('å‘é€éªŒè¯ç åˆ°:', phone);
        }
        
        function loginAsPassenger(e) {
            e.preventDefault();
            const phone = e.target.querySelector('input[type="tel"]').value;
            const code = e.target.querySelector('input[placeholder="è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç "]').value;
            const address = e.target.querySelector('input[placeholder="å¦‚ï¼šå¿»åŸå¿äººæ°‘åŒ»é™¢"]').value;
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            currentUser = {
                type: 'passenger',
                phone: phone,
                address: address,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // è·³è½¬åˆ°ä¹˜å®¢ç«¯
            showPage('passenger');
        }
        
        function loginAsDriver(e) {
            e.preventDefault();
            const driverId = e.target.querySelector('input[placeholder="è¯·è¾“å…¥å¸æœºç¼–å·"]').value;
            const plate = e.target.querySelector('input[placeholder="å¦‚ï¼šæ¡‚B12345"]').value;
            const password = e.target.querySelector('input[type="password"]').value;
            
            // éªŒè¯å¸æœºä¿¡æ¯
            if (driverId && plate && password) {
                currentUser = {
                    type: 'driver',
                    driverId: driverId,
                    plate: plate,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showPage('driver');
            } else {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            }
        }
        
        function quickLogin(type) {
            if (type === 'passenger') {
                currentUser = {
                    type: 'passenger',
                    phone: 'guest_' + Date.now(),
                    address: '',
                    isGuest: true,
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showPage('passenger');
            }
        }
        
        // ===== ä¹˜å®¢ç«¯åŠŸèƒ½ =====
        function initPassengerPage() {
            // åˆå§‹åŒ–ä¹˜å®¢é¡µé¢
            refreshLocation();
            loadPassengerOrders();
            updatePrice();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                } else {
                    showPage('login');
                    return;
                }
            }
        }
        
        function refreshLocation() {
            const locationElement = document.getElementById('currentLocation');
            locationElement.innerHTML = 'å®šä½ä¸­...';
            
            // æ¨¡æ‹Ÿå®šä½
            setTimeout(() => {
                const locations = [
                    'å¿»åŸå¿äººæ°‘åŒ»é™¢',
                    'å¤è“¬é•‡ä¸­å¿ƒ',
                    'å¿»åŸå¿æ±½è½¦ç«™',
                    'å¿»åŸå¿ä¸­å¿ƒå¹¿åœº'
                ];
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                locationElement.innerHTML = randomLocation;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('currentLocation', randomLocation);
            }, 1000);
        }
        
        function selectRoute(routeId) {
            currentRoute = routeId;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å¦‚æœæ˜¯è‡ªå®šä¹‰è·¯çº¿ï¼Œæ˜¾ç¤ºé¢å¤–è·ç¦»è¾“å…¥
            if (routeId === 'custom') {
                document.getElementById('extraDistanceGroup').style.display = 'block';
            } else {
                document.getElementById('extraDistanceGroup').style.display = 'none';
            }
            
            updatePrice();
        }
        
        function updateDestination() {
            const destination = document.getElementById('destinationInput').value;
            if (destination.length > 0) {
                updatePrice();
            }
        }
        
        function updateDistanceValue(value) {
            document.getElementById('distanceValue').textContent = value;
            updatePrice();
        }
        
        function updatePrice() {
            // åŸºç¡€ä»·æ ¼
            let basePrice = 50;
            
            // æ ¹æ®è·¯çº¿è°ƒæ•´åŸºç¡€ä»·æ ¼
            if (currentRoute === 'xincheng-liuzhou') {
                basePrice = 50;
            } else if (currentRoute === 'liuzhou-xincheng') {
                basePrice = 50;
            } else if (currentRoute === 'xincheng-laibin') {
                basePrice = 40;
            } else if (currentRoute === 'gupeng-xincheng') {
                basePrice = 20;
            } else if (currentRoute === 'custom') {
                basePrice = 50;
            }
            
            // é¢å¤–è·ç¦»è´¹ç”¨
            const extraDistance = parseInt(document.getElementById('extraDistance').value) || 0;
            let extraPrice = 0;
            
            if (extraDistance > 0) {
                if (extraDistance > 120) {
                    extraPrice = extraDistance * 0.61;
                } else if (extraDistance > 20) {
                    extraPrice = 20 * 0.8 + (extraDistance - 20) * 0.7;
                } else {
                    extraPrice = extraDistance * 0.8;
                }
            }
            
            // æ€»ä»·æ ¼
            const totalPrice = basePrice + extraPrice;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('basePrice').textContent = 'Â¥' + basePrice.toFixed(2);
            document.getElementById('extraPrice').textContent = 'Â¥' + extraPrice.toFixed(2);
            document.getElementById('totalPrice').textContent = 'Â¥' + totalPrice.toFixed(2);
            document.getElementById('finalPrice').textContent = 'Â¥' + totalPrice.toFixed(2);
            
            return totalPrice;
        }
        
        function resetBooking() {
            document.getElementById('destinationInput').value = '';
            document.getElementById('extraDistance').value = 0;
            document.getElementById('distanceValue').textContent = '0';
            document.getElementById('locationNote').value = '';
            document.getElementById('driversCard').style.display = 'none';
            
            // é‡ç½®è·¯çº¿é€‰æ‹©
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.route-btn').classList.add('active');
            currentRoute = 'xincheng-liuzhou';
            
            updatePrice();
        }
        
        function showDrivers() {
            const destination = document.getElementById('destinationInput').value;
            if (!destination) {
                alert('è¯·å…ˆè¾“å…¥ç›®çš„åœ°');
                return;
            }
            
            // æ˜¾ç¤ºå¸æœºå¡ç‰‡
            document.getElementById('driversCard').style.display = 'block';
            
            // åŠ è½½å¸æœºåˆ—è¡¨
            const driversList = document.getElementById('driversList');
            driversList.innerHTML = '';
            
            // æ¨¡æ‹Ÿå¸æœºæ•°æ®
            const drivers = [
                { name: 'æå¸ˆå‚…', plate: 'æ¡‚B12345', rating: 4.8, distance: '2.5å…¬é‡Œ', time: '5åˆ†é’Ÿ' },
                { name: 'å¼ å¸ˆå‚…', plate: 'æ¡‚B56789', rating: 4.9, distance: '3.2å…¬é‡Œ', time: '8åˆ†é’Ÿ' },
                { name: 'ç‹å¸ˆå‚…', plate: 'æ¡‚B34567', rating: 4.7, distance: '1.8å…¬é‡Œ', time: '3åˆ†é’Ÿ' }
            ];
            
            drivers.forEach(driver => {
                const driverElement = document.createElement('div');
                driverElement.className = 'order-item';
                driverElement.style.cursor = 'pointer';
                driverElement.onclick = () => selectDriver(driver);
                driverElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">ğŸš—</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="font-weight: bold;">${driver.name}</div>
                                <div style="font-size: 12px; color: #666;">${driver.plate}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <div>è¯„åˆ†: ${driver.rating} â˜…</div>
                                <div style="font-size: 12px; color: #666;">è·ç¦»${driver.distance} Â· ${driver.time}åˆ°è¾¾</div>
                            </div>
                        </div>
                    </div>
                `;
                driversList.appendChild(driverElement);
            });
        }
        
        function selectDriver(driver) {
            const price = updatePrice();
            const destination = document.getElementById('destinationInput').value;
            
            // åˆ›å»ºè®¢å•
            const order = {
                id: 'ORD' + Date.now().toString().slice(-8),
                driver: driver.name,
                plate: driver.plate,
                from: localStorage.getItem('currentLocation') || 'æœªçŸ¥ä½ç½®',
                to: destination,
                note: document.getElementById('locationNote').value,
                price: price,
                status: 'å¾…æ”¯ä»˜',
                time: new Date().toLocaleString('zh-CN')
            };
            
            // ä¿å­˜è®¢å•
            savePassengerOrder(order);
            
            // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
            document.getElementById('paymentAmount').textContent = 'Â¥' + price.toFixed(2);
            showPage('payment');
        }
        
        function savePassengerOrder(order) {
            let orders = JSON.parse(localStorage.getItem('passengerOrders') || '[]');
            orders.push(order);
            localStorage.setItem('passengerOrders', JSON.stringify(orders));
            
            // æ›´æ–°è®¢å•åˆ—è¡¨
            loadPassengerOrders();
        }
        
        function loadPassengerOrders() {
            const ordersList = document.getElementById('passengerOrders');
            ordersList.innerHTML = '';
            
            const orders = JSON.parse(localStorage.getItem('passengerOrders') || '[]');
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— è®¢å•</div>';
                return;
            }
            
            // åªæ˜¾ç¤ºæœ€è¿‘çš„5ä¸ªè®¢å•
            const recentOrders = orders.slice(-5).reverse();
            
            recentOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                orderElement.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">${order.id}</span>
                        <span class="order-status">${order.status}</span>
                    </div>
                    <div class="order-route">${order.from} â†’ ${order.to}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <div class="order-time">${order.time}</div>
                        <div style="font-weight: bold; color: #e74c3c;">Â¥${order.price.toFixed(2)}</div>
                    </div>
                `;
                ordersList.appendChild(orderElement);
            });
        }
        
        function switchPassengerTab(tab) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('#passengerPage .tab-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // è¿™é‡Œå¯ä»¥æ ¹æ®tabåˆ‡æ¢å†…å®¹ï¼Œæš‚æ—¶åªå®ç°é¦–é¡µ
        }
        
        // ===== å¸æœºç«¯åŠŸèƒ½ =====
        function initDriverPage() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser || currentUser.type !== 'driver') {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                } else {
                    showPage('login');
                    return;
                }
            }
            
            loadDriverRoutes();
            loadDriverOrders();
            loadDriverStats();
        }
        
        function toggleDriverStatus() {
            const statusText = document.getElementById('driverStatusText');
            const toggleBtn = document.getElementById('toggleStatusBtn');
            
            if (statusText.classList.contains('status-online')) {
                statusText.classList.remove('status-online');
                statusText.classList.add('status-offline');
                statusText.textContent = 'â— å·²ä¸‹çº¿';
                toggleBtn.textContent = 'å¼€å§‹æ¥å•';
                toggleBtn.classList.add('btn-primary');
                toggleBtn.classList.remove('btn-secondary');
            } else {
                statusText.classList.remove('status-offline');
                statusText.classList.add('status-online');
                statusText.textContent = 'â— åœ¨çº¿æ¥å•ä¸­';
                toggleBtn.textContent = 'åœæ­¢æ¥å•';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-secondary');
            }
        }
        
        function showAddRouteModal() {
            showModal('addRouteModal');
        }
        
        function updateRoutePoints() {
            const startSelect = document.getElementById('routeStart');
            const endSelect = document.getElementById('routeEnd');
            const customStart = document.getElementById('customStart');
            const customEnd = document.getElementById('customEnd');
            
            customStart.style.display = startSelect.value === 'custom' ? 'block' : 'none';
            customEnd.style.display = endSelect.value === 'custom' ? 'block' : 'none';
            
            // é˜²æ­¢èµ·ç‚¹å’Œç»ˆç‚¹ç›¸åŒ
            if (startSelect.value === endSelect.value && startSelect.value !== 'custom') {
                alert('èµ·ç‚¹å’Œç»ˆç‚¹ä¸èƒ½ç›¸åŒï¼');
                endSelect.selectedIndex = (startSelect.selectedIndex + 1) % endSelect.options.length;
            }
        }
        
        function toggleReturnSettings() {
            const returnSettings = document.getElementById('returnSettings');
            returnSettings.style.display = event.target.checked ? 'block' : 'none';
        }
        
        function saveRoute(e) {
            e.preventDefault();
            const form = e.target;
            
            // æ”¶é›†æ•°æ®
            const routeData = {
                id: 'route_' + Date.now(),
                name: form.querySelector('input[placeholder="å¦‚ï¼šå¿»åŸâ†’æŸ³å·å¾€è¿”çº¿"]').value,
                start: form.querySelector('#routeStart').value,
                end: form.querySelector('#routeEnd').value,
                customStart: form.querySelector('#customStart').value || null,
                customEnd: form.querySelector('#customEnd').value || null,
                isRoundTrip: form.querySelector('#isRoundTrip').checked,
                departureTime: form.querySelector('input[type="time"]').value,
                seats: form.querySelector('input[placeholder="åº§ä½æ•°"]').value,
                description: form.querySelector('textarea').value
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            let routes = JSON.parse(localStorage.getItem('driverRoutes') || '[]');
            routes.push({
                ...routeData,
                createdAt: new Date().toISOString(),
                active: true
            });
            localStorage.setItem('driverRoutes', JSON.stringify(routes));
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal('addRouteModal');
            
            // é‡æ–°åŠ è½½è·¯çº¿åˆ—è¡¨
            loadDriverRoutes();
            
            alert('è·¯çº¿æ·»åŠ æˆåŠŸï¼');
        }
        
        function loadDriverRoutes() {
            const routesList = document.getElementById('driverRoutes');
            routesList.innerHTML = '';
            
            const routes = JSON.parse(localStorage.getItem('driverRoutes') || '[]');
            
            if (routes.length === 0) {
                routesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— è·¯çº¿ï¼Œè¯·æ·»åŠ è·¯çº¿</div>';
                return;
            }
            
            routes.forEach(route => {
                const routeElement = document.createElement('div');
                routeElement.className = 'route-item';
                
                const start = route.customStart || route.start;
                const end = route.customEnd || route.end;
                const display = `${start} â†’ ${end} ${route.isRoundTrip ? 'ğŸ”„' : ''}`;
                
                routeElement.innerHTML = `
                    <div class="route-info">
                        <h4>${route.name}</h4>
                        <div class="route-path">${display}</div>
                        <div style="font-size: 12px; color: #666;">å‘è½¦: ${route.departureTime} | åº§ä½: ${route.seats}</div>
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-small" onclick="editRoute('${route.id}')">ç¼–è¾‘</button>
                        <button class="btn btn-small ${route.active ? 'btn-secondary' : 'btn-primary'}" onclick="toggleRouteActive('${route.id}')">
                            ${route.active ? 'åœç”¨' : 'å¯ç”¨'}
                        </button>
                    </div>
                `;
                routesList.appendChild(routeElement);
            });
        }
        
        function saveDriverSettings() {
            const settings = {
                basePrice: parseFloat(document.getElementById('driverBasePrice').value),
                extraRate: parseFloat(document.getElementById('driverExtraRate').value),
                holidayRate: parseInt(document.getElementById('driverHolidayRate').value)
            };
            
            localStorage.setItem('driverSettings', JSON.stringify(settings));
        }
        
        function loadDriverStats() {
            // æ¨¡æ‹Ÿç»Ÿè®¡æ•°æ®
            document.getElementById('todayOrders').textContent = '5';
            document.getElementById('todayIncome').textContent = 'Â¥325';
            document.getElementById('driverRating').textContent = '4.8';
            document.getElementById('driverBalance').textContent = 'Â¥650';
        }
        
        function loadDriverOrders() {
            const ordersList = document.getElementById('driverCurrentOrders');
            ordersList.innerHTML = '';
            
            // æ¨¡æ‹Ÿè®¢å•æ•°æ®
            const orders = [
                {
                    id: 'ORD001',
                    passenger: 'å¼ å…ˆç”Ÿ',
                    from: 'å¿»åŸå¿äººæ°‘åŒ»é™¢',
                    to: 'æŸ³å·ç«è½¦ç«™',
                    time: '14:30',
                    price: 'Â¥65.00',
                    status: 'è¿›è¡Œä¸­'
                },
                {
                    id: 'ORD002',
                    passenger: 'æå¥³å£«',
                    from: 'å¤è“¬é•‡',
                    to: 'æŸ³å·å¸‚ä¸­å¿ƒ',
                    time: '15:00',
                    price: 'Â¥70.00',
                    status: 'å¾…æ¥å•'
                }
            ];
            
            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                orderElement.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">${order.id}</span>
                        <span class="order-status">${order.status}</span>
                    </div>
                    <div class="order-route">${order.from} â†’ ${order.to}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <div style="font-size: 12px; color: #666;">ä¹˜å®¢: ${order.passenger} | æ—¶é—´: ${order.time}</div>
                        <div style="font-weight: bold; color: #e74c3c;">${order.price}</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-small" onclick="viewOrderDetail('${order.id}')">æŸ¥çœ‹</button>
                        <button class="btn btn-small btn-primary" onclick="acceptOrder('${order.id}')" ${order.status === 'è¿›è¡Œä¸­' ? 'disabled' : ''}>æ¥å•</button>
                    </div>
                `;
                ordersList.appendChild(orderElement);
            });
        }
        
        function switchDriverTab(tab) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('#driverPage .tab-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // ===== èŠå¤©åŠŸèƒ½ =====
        function openChat(userType) {
            // è®¾ç½®èŠå¤©å¯¹è±¡
            if (userType === 'passenger') {
                currentChatWith = { name: 'æå¸ˆå‚…', type: 'driver' };
            } else {
                currentChatWith = { name: 'å¼ å…ˆç”Ÿ', type: 'passenger' };
            }
            
            document.getElementById('chatWith').textContent = currentChatWith.name;
            showPage('chat');
            loadChatMessages();
        }
        
        function goBackFromChat() {
            if (currentUser.type === 'passenger') {
                showPage('passenger');
            } else {
                showPage('driver');
            }
        }
        
        function adjustChatInput() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageBtn');
            
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            
            // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
            sendBtn.disabled = input.value.trim() === '';
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
            addChatMessage(text, 'sent');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            adjustChatInput();
            
            // ä¿å­˜æ¶ˆæ¯
            saveChatMessage(text, 'sent');
            
            // æ¨¡æ‹Ÿå¯¹æ–¹å›å¤
            setTimeout(() => {
                const replies = [
                    'å¥½çš„ï¼Œæ”¶åˆ°',
                    'å¤§æ¦‚10åˆ†é’Ÿååˆ°',
                    'æˆ‘åœ¨è·¯å£ç­‰ä½ ',
                    'è¯·ç¨ç­‰ï¼Œé©¬ä¸Šåˆ°',
                    'æ²¡é—®é¢˜'
                ];
                const reply = replies[Math.floor(Math.random() * replies.length)];
                addChatMessage(reply, 'received');
                saveChatMessage(reply, 'received');
            }, 1000 + Math.random() * 2000);
        }
        
        function addChatMessage(text, type) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function saveChatMessage(text, type) {
            const chatKey = `chat_${currentUser.type}_${currentChatWith.type}`;
            let chatHistory = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            chatHistory.push({
                text: text,
                type: type,
                time: new Date().toISOString()
            });
            
            localStorage.setItem(chatKey, JSON.stringify(chatHistory));
        }
        
        function loadChatMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            const chatKey = `chat_${currentUser.type}_${currentChatWith.type}`;
            const chatHistory = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            if (chatHistory.length === 0) {
                addChatMessage('ç³»ç»Ÿï¼šå¼€å§‹èŠå¤©å§ï¼', 'system');
                return;
            }
            
            chatHistory.forEach(msg => {
                addChatMessage(msg.text, msg.type);
            });
        }
        
        // ===== æ”¯ä»˜åŠŸèƒ½ =====
        function selectPaymentMethod(method) {
            currentPaymentMethod = method;
            
            // æ›´æ–°UI
            document.querySelectorAll('.method-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('div:last-child').style.backgroundColor = 'transparent';
            });
            
            event.target.closest('.method-item').classList.add('active');
            event.target.closest('.method-item').querySelector('div:last-child').style.backgroundColor = '#667eea';
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ”¯ä»˜æ–¹å¼å†…å®¹
            document.getElementById('wechatQR').style.display = method === 'wechat' ? 'block' : 'none';
            document.getElementById('alipayQR').style.display = method === 'alipay' ? 'block' : 'none';
            document.getElementById('cashInstructions').style.display = method === 'cash' ? 'block' : 'none';
        }
        
        function uploadQRCode(type) {
            document.getElementById('uploadQRType').textContent = `ä¸Šä¼ ${type === 'wechat' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®'}æ”¶æ¬¾ç `;
            showModal('uploadQRModal');
        }
        
        function handleQRUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸Šä¼ é€»è¾‘ï¼Œä½†å•æ–‡ä»¶ç‰ˆæœ¬åªèƒ½æ¨¡æ‹Ÿ
            alert('æ”¶æ¬¾ç ä¸Šä¼ æˆåŠŸï¼ˆæ¼”ç¤ºåŠŸèƒ½ï¼‰');
            closeModal('uploadQRModal');
        }
        
        function startPaymentTimer() {
            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (paymentTimer) {
                clearInterval(paymentTimer);
            }
            
            paymentTimeLeft = 15 * 60; // 15åˆ†é’Ÿ
            
            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            updatePaymentCountdown();
            
            // å¯åŠ¨è®¡æ—¶å™¨
            paymentTimer = setInterval(() => {
                paymentTimeLeft--;
                updatePaymentCountdown();
                
                if (paymentTimeLeft <= 0) {
                    clearInterval(paymentTimer);
                    alert('æ”¯ä»˜è¶…æ—¶ï¼Œè®¢å•å·²å–æ¶ˆ');
                    showPage('passenger');
                }
            }, 1000);
        }
        
        function updatePaymentCountdown() {
            const minutes = Math.floor(paymentTimeLeft / 60);
            const seconds = paymentTimeLeft % 60;
            
            document.getElementById('paymentCountdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function processPayment() {
            // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
            const payBtn = document.querySelector('#paymentPage .btn-primary');
            payBtn.disabled = true;
            payBtn.innerHTML = '<span class="loading"></span> æ”¯ä»˜ä¸­...';
            
            setTimeout(() => {
                // æˆåŠŸæ¦‚ç‡90%
                const success = Math.random() > 0.1;
                
                if (success) {
                    // æ”¯ä»˜æˆåŠŸ
                    clearInterval(paymentTimer);
                    
                    // æ›´æ–°è®¢å•çŠ¶æ€
                    updateOrderStatus('å·²æ”¯ä»˜');
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¨¡æ€æ¡†
                    showModal('paymentSuccessModal');
                } else {
                    // æ”¯ä»˜å¤±è´¥
                    alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    payBtn.disabled = false;
                    payBtn.textContent = 'ç¡®è®¤æ”¯ä»˜';
                }
            }, 2000);
        }
        
        function updateOrderStatus(status) {
            // æ›´æ–°æœ¬åœ°å­˜å‚¨ä¸­çš„è®¢å•çŠ¶æ€
            let orders = JSON.parse(localStorage.getItem('passengerOrders') || '[]');
            if (orders.length > 0) {
                orders[orders.length - 1].status = status;
                localStorage.setItem('passengerOrders', JSON.stringify(orders));
            }
        }
        
        function closePaymentSuccess() {
            closeModal('paymentSuccessModal');
            showPage('passenger');
            
            // é‡æ–°åŠ è½½è®¢å•
            loadPassengerOrders();
        }
        
        // ===== é€šç”¨åŠŸèƒ½ =====
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showWithdraw() {
            alert('æç°åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        
        function viewOrderDetail(orderId) {
            alert('æŸ¥çœ‹è®¢å•è¯¦æƒ…: ' + orderId);
        }
        
        function acceptOrder(orderId) {
            alert('å·²æ¥å•: ' + orderId);
            // é‡æ–°åŠ è½½è®¢å•
            loadDriverOrders();
        }
        
        function editRoute(routeId) {
            alert('ç¼–è¾‘è·¯çº¿: ' + routeId);
        }
        
        function toggleRouteActive(routeId) {
            alert('åˆ‡æ¢è·¯çº¿çŠ¶æ€: ' + routeId);
        }
        
        // ===== é¡µé¢åŠ è½½åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPage(currentUser.type === 'passenger' ? 'passenger' : 'driver');
            } else {
                showPage('login');
            }
            
            // å¾®ä¿¡ç¯å¢ƒæ£€æµ‹
            const ua = navigator.userAgent.toLowerCase();
            const isWechat = ua.indexOf('micromessenger') !== -1;
            
            if (!isWechat) {
                console.log('éå¾®ä¿¡ç¯å¢ƒï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™');
            }
            
            // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
            if (!localStorage.getItem('passengerOrders')) {
                localStorage.setItem('passengerOrders', JSON.stringify([]));
            }
            
            if (!localStorage.getItem('driverRoutes')) {
                localStorage.setItem('driverRoutes', JSON.stringify([]));
            }
            
            if (!localStorage.getItem('driverSettings')) {
                localStorage.setItem('driverSettings', JSON.stringify({
                    basePrice: 50,
                    extraRate: 0.8,
                    holidayRate: 20
                }));
            }
            
            // åŠ è½½å¸æœºè®¾ç½®
            const settings = JSON.parse(localStorage.getItem('driverSettings'));
            if (settings) {
                document.getElementById('driverBasePrice').value = settings.basePrice;
                document.getElementById('driverExtraRate').value = settings.extraRate;
                document.getElementById('driverHolidayRate').value = settings.holidayRate;
            }
        });
    </script>
</body>
</html>